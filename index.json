[{"content":"MacOS在企业端使用docker desktop受限，docker服务端无法启动导致docker服务端的一般能力无法使用。虽然大多数时候docker编译构建已经被流水线或自动化脚本等托管，但是在学习初期或调试阶段仍然需要在本地制作镜像或运行容器。 因此，本教程选择使用colima代替docker desktop。\ncolima会利用lima(linux on Mac)虚拟机，在lima中启动docker服务，让本地的docker-cli直接访问lima虚拟机中的docker服务，从而绕开docker服务在MacOS本地无法启动的问题。\nPrepare 安装需要的组件：\n# docker \u0026amp; colima on mac brew install --cask docker brew install colima brew install docker-compose brew install colima的时候会自动安装lima，如果lima已经被安装则会跳过该部分的安装。\nlima \u0026amp; colima colima依赖于lima(Linux on mac)，通过lima启动Linux虚拟机让docker客户端访问虚拟机中的docker服务，从而使得docker对用户提供的一般能力可以正常使用。\nLima的相关使用 # 启动一个default linux虚拟机 limactl start default # 查看当前linux虚拟机 limactl list # 进入虚拟机的shell换将 limactl shell default lima会默认挂载在mac的根目录下，即全部目录，进入linux shell后可以访问mac的全部目录。 通过修改配置文件的方式修改挂载目录\n# 进入默认linux虚拟机的dir cd ~/.lima/default # 修改lima.yaml文件的挂载目录 vim lima.yaml Run！ 首先启动colima保证docker服务启动\ncolima start --cpu 4 --memory 6 --disk 60 使用docker\ndocker \u0026lt;command\u0026gt; Colima trap colima的踩坑指南\n思考这样一个问题，如果我们本地起了一个服务，服务需要依赖MySql、Redis等中间件，那么直接基于上述环境搭建起来的docker去编译构建镜像并跑该服务对应的容器会有问题吗。\n答案显然是会的\n因为colima是基于lima启动的运行时环境，而虚拟机的网络是独立的，所以colima启动的容器无法访问宿主机本地的网络，也就无法访问本地的MySql、Redis等环境。\n我们在可能会习惯于在config.toml中配置dev环境的一些环境变量，以MySql为例，可能会存在如下config.toml文件。\n[Mysql] host = \u0026#34;localhost\u0026#34; port = 3306 user = \u0026#34;root\u0026#34; password = \u0026#34;password\u0026#34; 通过如上配置，程序会在运行时访问本地的MySql服务。而如果这个程序被制作成镜像在本地运行的时候，由于我们的docker daemon运行在虚拟机环境中，运行的container无法直接访问宿主机的网络环境，也就无法访问本地的MySql、Redis等服务。\n要解决上述问题，也不是完全没有办法，我们可以使用host.docker.internal这个域名来替代localhost，但是实际上host.docker.internal不是Linux，Docker Engine的原生概念，而是Docker为我们所提供的在原生Linux环境下的“宿主机访问别名”。在容器的运行时中，可以通过将localhost替换为host.docker.internal来达到访问宿主机中中间件的目的。\nPractice 在具体的实现层面，首先需要对服务端代码做出一定的适配，这层改造的目的让服务端可以通过获取环境变量的方式来覆盖配置文件。我们以Golang的Viper为例。AutomaticEnv()可以从环境变量中加载配置，SetEnvKeyReplacer可以环境变量中的.替换成_，例如，从config.toml中获取的mysql.user可以被环境变量MYSQL_USER覆盖。\nviper.AutomaticEnv() viper.SetEnvKeyReplacer(strings.NewReplacer(\u0026#34;.\u0026#34;, \u0026#34;_\u0026#34;)) 经过上述改造，我们的服务就可以实现在docker run命令中通过-e参数来覆盖配置文件中的环境变量，例如：\ndocker run -e MYSQL_HOST=host.docker.internal -e MYSQL_PORT=3306 -e MYSQL_USER=root -e MYSQL_PASSWORD=password my-service 这样的方式可以实现，但是当配置文件过多的时候，手动输入每一个环境变量过于繁琐，可以通过-env-file参数来指定一个环境变量文件，例如：\ndocker run -env-file .env my-service 其中.env文件的内容如下：\nMYSQL_HOST=host.docker.internal MYSQL_PORT=3306 MYSQL_USER=root MYSQL_PASSWORD=password 这样就可以实现通过环境变量文件来覆盖配置文件中的环境变量。\n","permalink":"https://kosnamm.github.io/posts/docker-setup-on-macos/","summary":"\u003cp\u003eMacOS在企业端使用docker desktop受限，docker服务端无法启动导致docker服务端的一般能力无法使用。虽然大多数时候docker编译构建已经被流水线或自动化脚本等托管，但是在学习初期或调试阶段仍然需要在本地制作镜像或运行容器。\n因此，本教程选择使用colima代替docker desktop。\u003c/p\u003e\n\u003cp\u003e\u003cem\u003ecolima会利用lima(linux on Mac)虚拟机，在lima中启动docker服务，让本地的docker-cli直接访问lima虚拟机中的docker服务，从而绕开docker服务在MacOS本地无法启动的问题。\u003c/em\u003e\u003c/p\u003e\n\u003ch1 id=\"prepare\"\u003ePrepare\u003c/h1\u003e\n\u003cp\u003e安装需要的组件：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# docker \u0026amp; colima on mac\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebrew install --cask docker\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebrew install colima\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebrew install docker-compose\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003ccode\u003ebrew install colima\u003c/code\u003e的时候会自动安装\u003ccode\u003elima\u003c/code\u003e，如果\u003ccode\u003elima\u003c/code\u003e已经被安装则会跳过该部分的安装。\u003c/p\u003e\n\u003ch1 id=\"lima--colima\"\u003elima \u0026amp; colima\u003c/h1\u003e\n\u003cp\u003ecolima依赖于\u003ca href=\"https://github.com/lima-vm/lima\"\u003elima\u003c/a\u003e(Linux on mac)，通过lima启动Linux虚拟机让docker客户端访问虚拟机中的docker服务，从而使得docker对用户提供的一般能力可以正常使用。\u003c/p\u003e\n\u003ch2 id=\"lima的相关使用\"\u003eLima的相关使用\u003c/h2\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 启动一个default linux虚拟机\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elimactl start default\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 查看当前linux虚拟机\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elimactl list\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 进入虚拟机的shell换将\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elimactl shell default\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003elima会默认挂载在mac的根目录下，即全部目录，进入linux shell后可以访问mac的全部目录。\n\u003cem\u003e通过修改配置文件的方式修改挂载目录\u003c/em\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 进入默认linux虚拟机的dir\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e ~/.lima/default\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e# 修改lima.yaml文件的挂载目录\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003evim lima.yaml\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"picture\" loading=\"lazy\" src=\"/dockersetup/lima_config.png\"\u003e\u003c/p\u003e\n\u003ch1 id=\"run\"\u003eRun！\u003c/h1\u003e\n\u003cp\u003e首先启动colima保证docker服务启动\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ecolima start --cpu \u003cspan class=\"m\"\u003e4\u003c/span\u003e --memory \u003cspan class=\"m\"\u003e6\u003c/span\u003e --disk \u003cspan class=\"m\"\u003e60\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e使用docker\u003c/p\u003e","title":"Setup Docker on MacOS"},{"content":"","permalink":"https://kosnamm.github.io/multi-agent_based_text2sql_middleware/","summary":"","title":"Multi Agent Based Text2sql Middleware"}]